(function(){var e;e="undefined"!=typeof exports&&null!==exports?exports:this,e.Nib={Plugins:{}}}).call(this),function(){var e=[].slice;Nib.Events=function(){function t(){this.handlers={}}return t.prototype.on=function(e,t){return null==this.handlers[e]&&(this.handlers[e]=[]),this.handlers[e].push(t),this},t.prototype.off=function(e,t){return null!=this.handlers[e]&&(this.handlers[e]=this.handlers[e].filter(function(e){return e===!t})),this},t.prototype.trigger=function(){var t,n,r,o,i,s;if(r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.handlers[r]){for(s=this.handlers[r],o=0,i=s.length;i>o;o++)n=s[o],n.apply(null,e.call(t).concat([this]));return this}},t.prototype.clear=function(){return this.handlers={}},t}()}.call(this),function(){var e=[].slice;Nib.Utils={capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},parentNodes:function(e,t){var n,r,o,i,s;if(t instanceof Array){for(s=[],o=0,i=t.length;i>o;o++)n=t[o],s.push(this.parentNodes(e,n));return s}for(r=[];t&&t!==e;)r.push(t),t=t.parentNode;return r},flatten:function(e){return 0===e.length?[]:e.reduce(function(e,t){return e.concat(t)})},indexOf:function(e,t){var n;for(n=0;n<e.length;){if(e[n]===t)return n;n+=1}return-1},uniqueNodes:function(e){var t,n,r,o,i,s;for(n=[],r=0,i=e.length;i>r;r++)t=e[r],t._visited||n.push(t),t._visited=!0;for(o=0,s=n.length;s>o;o++)t=n[o],t._visited=!1;return n},domNodes:function(e){return e.filter(function(e){return 1===e.nodeType})},rangyDetach:function(){var t,n,r,o,i,s;for(t=1<=arguments.length?e.call(arguments,0):[],s=[],o=0,i=t.length;i>o;o++)if(r=t[o])try{s.push(r.detach())}catch(a){n=a,s.push(null)}return s}}}.call(this),function(){var e;e=Nib.Utils,Nib.SelectionHandler=function(){function e(){var e;e=rangy.getSelection(),e.rangeCount&&(this.range=e.getRangeAt(0),this.backwards=e.isBackwards())}return e.prototype.restoreSelection=function(){var e,t;return this.range?(e=rangy.createRange(),e.setStart(this.range.startContainer,this.range.startOffset),e.setEnd(this.range.endContainer,this.range.endOffset),t=rangy.getSelection(),t.removeAllRanges(),t.addRange(e,this.backwards)):void 0},e.prototype.collapseToEnd=function(){return rangy.getSelection().collapseToEnd()},e.prototype.collapseToStart=function(){return rangy.getSelection().collapseToStart()},e}()}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function r(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e},r=[].slice;e=Nib.Utils,Nib.Editor=function(t){function o(e){null==e&&(e={}),this.opts=e,this.plugins=e.plugins||[],this.node=e.node,this.originalClass=this.node.className,this.originalContent=this.node.innerHTML,o.__super__.constructor.call(this,e)}return n(o,t),o.prototype.activate=function(){var t,n,r,o,i;for(this.node.setAttribute("contenteditable",!0),i=this.plugins,r=0,o=i.length;o>r;r++)n=i[r],t=e.capitalize(n),this[n]=new Nib.Plugins[t](this);return this.initDOMEvents(),this.trigger("editor:on")},o.prototype.deactivate=function(){var e,t,n,r;for(this.node.setAttribute("contenteditable",!1),r=this.plugins,t=0,n=r.length;n>t;t++)e=r[t],this[e].deactivate();return this.deactivateDOMEvents(),this.trigger("editor:off"),this.clear()},o.prototype.hasChanged=function(){return this.node.innerHTML!==this.originalContent},o.prototype.revert=function(){return this.node.innerHTML=this.originalContent},o.prototype.exec=function(){var e,t;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],e.length>0?document.execCommand.apply(document,[t,!1].concat(r.call(e))):document.execCommand(t,!1,this.getSelection()),this.checkSelection()},o.prototype.initDOMEvents=function(){return this.node.addEventListener("keydown",this.onKeydown.bind(this)),this.node.addEventListener("keyup",this.onKeyup.bind(this)),this.node.addEventListener("mouseup",this.onMouseup.bind(this))},o.prototype.deactivateDOMEvents=function(){return this.node.removeEventListener("keydown",this.onKeydown),this.node.removeEventListener("keyup",this.onKeyup),this.node.removeEventListener("mouseup",this.onMouseup)},o.prototype.onKeydown=function(e){return this.trigger("keydown",e)},o.prototype.onKeyup=function(){return this.checkSelection()},o.prototype.onMouseup=function(){return this.checkSelection()},o.prototype.getContent=function(){return this.node.innerHTML},o.prototype.rangeBeforeSelection=function(){var e,t;return t=this.getSelection(),e=rangy.createRange(),e.setStart(this.node,0),e.setEnd(t.anchorNode,t.anchorOffset),e},o.prototype.contentBeforeSelection=function(){return this.rangeBeforeSelection().toHtml()},o.prototype.rangeInSelection=function(){var e;return e=this.getSelection(),e.getRangeAt(0)},o.prototype.contentInSelection=function(){return this.rangeInSelection().toHtml()},o.prototype.rangeAfterSelection=function(){var e,t,n;return n=this.getSelection(),t=n.getRangeAt(0),e=rangy.createRange(),e.setStart(t.endContainer,t.endOffset),e.setEnd(this.node,this.node.childNodes.length),e},o.prototype.contentAfterSelection=function(){return this.rangeAfterSelection().toHtml()},o.prototype.isCaretAtNodeStart=function(){var e;return""===(null!=(e=this.rangeBeforeSelection())?e.toString():void 0)},o.prototype.moveCaretToNodeEnd=function(){var e,t;return e=rangy.createRange(),e.selectNodeContents(this.node),e.collapse(!1),t=rangy.getSelection(),t.removeAllRanges(),t.addRange(e)},o.prototype.getSelection=function(){return rangy.getSelection()},o.prototype.getSelectedNodes=function(t){var n,r;return null==t&&(t=null),t=t||this.getSelection(),n=[],t.rangeCount&&(r=t.getRangeAt(0),r.collapsed?(r.startContainer||r.endContainer)&&(n=[r.startContainer||r.endContainer]):n=r.getNodes(),n=e.uniqueNodes(e.flatten(e.parentNodes(this.node,n))),this.detach(r)),this.detach(t),n},o.prototype.checkSelection=function(e){var t,n,r,o,i,s;for(null==e&&(e=null),e=e||this.getSelection(),e.rangeCount&&(r=e.getRangeAt(0)),n={selection:e,range:r,nodes:this.getSelectedNodes(e),states:[]},s=this.plugins,o=0,i=s.length;i>o;o++)t=s[o],this[t].checkSelection(n)&&n.states.push(t);return this.trigger("report",n),this.detach(r)},o.prototype.detach=function(){var t;return t=1<=arguments.length?r.call(arguments,0):[],e.rangyDetach.apply(e,t)},o.prototype.saveSelection=function(){return new Nib.SelectionHandler},o.prototype.restoreSelection=function(e){return e.restoreSelection(),this.checkSelection()},o.prototype.selectNode=function(e,t){var n;return null==t&&(t=null),t=t||this.getSelection(),t.rangeCount?(n=t.getRangeAt(0),n.selectNode(e)):(n=rangy.createRange(),n.selectNodeContents(e)),t.setSingleRange(n),this.checkSelection(t)},o.prototype.wrap=function(e,t){var n,r,o;return null==t&&(t=null),t=t||this.getSelection(),t.rangeCount&&(o=t.getRangeAt(0)),r=document.createElement(e),o&&o.canSurroundContents()&&o.surroundContents(r),n=rangy.createRange(),n.selectNodeContents(r),t.setSingleRange(n),this.checkSelection(t),this.detach(o),r},o.prototype.findTags=function(e,t){var n,r,o,i;for(e=e.toUpperCase(),i=[],r=0,o=t.length;o>r;r++)n=t[r],1===n.nodeType&&n.tagName===e&&i.push(n);return i},o.prototype.findTag=function(e,t){var n,r,o;for(e=e.toUpperCase(),r=0,o=t.length;o>r;r++)if(n=t[r],1===n.nodeType&&n.tagName===e)return n},o.prototype.wrapped=function(e){return this.findTag(e,this.getSelectedNodes())},o.prototype.findBoundary=function(e,t){for(e=e.toUpperCase();t!==this.node;){if(1===t.nodeType&&(t.tagName=e))return!0;t=t.parentNode}return!1},o.prototype.splitNodeBoundary=function(t,n,r){var o,i,s,a,l;return l=t.parentNode,o=l.cloneNode(!0),i=o.firstChild,s=l.parentNode,r?(i.deleteData(n,i.textContent.length),t.deleteData(0,n),s.insertBefore(o,l)):(i.deleteData(0,n),t.deleteData(n,i.textContent.length),a=l.nextSibling,a?s.insertBefore(o,a):s.appendChild(o)),[s,e.indexOf(s.childNodes,l)]},o.prototype.splitElementBoundry=function(t,n,r){var o,i,s,a,l,c,u;if(o=t.cloneNode(!1),s=t.parentNode,i=t.childNodes,r){if(n)for(c=1;n>=1?n>=c:c>=n;n>=1?c++:c--)o.appendChild(i[0]);s.insertBefore(o,t)}else{if(l=i.length-n-1)for(u=1;l>=1?l>=u:u>=l;l>=1?u++:u--)o.appendChild(i[n+1]);a=t.nextSibling,a?s.insertBefore(o,a):s.appendChild(o)}return[s,e.indexOf(s.childNodes,t)]},o.prototype.splitBoundaryRecursive=function(e,t,n,r){var o,i,s;for(e=e.toUpperCase();;){if(t===this.node)return;if(o=1===t.nodeType&&t.tagName===e,1===t.nodeType?(i=this.splitElementBoundry(t,n,r),t=i[0],n=i[1]):(s=this.splitNodeBoundary(t,n,r),t=s[0],n=s[1]),o)return}},o.prototype.splitBoundaries=function(e){var t,n;return n=rangy.getSelection(),n.rangeCount&&(t=n.getRangeAt(0),t.collapsed||(t.startContainer&&this.findBoundary(e,t.startContainer)&&t.startOffset>0&&(this.splitBoundaryRecursive(e,t.startContainer,t.startOffset,!0),t.refresh()),t.endContainer&&this.findBoundary(e,t.endContainer)&&t.endOffset<t.endContainer.length&&(this.splitBoundaryRecursive(e,t.endContainer,t.endOffset,!1),t.refresh())),this.detach(t)),this.detach(n)},o.prototype.unwrap=function(e){var t,n,r,o,i,s;for(this.splitBoundaries(e),r=this.saveSelection(),s=this.findTags(e,this.getSelectedNodes()),o=0,i=s.length;i>o;o++){for(n=s[o];t=n.firstChild;)n.parentNode.insertBefore(t,n);n.parentNode.removeChild(n)}return this.restoreSelection(r),this.checkSelection()},o}(Nib.Events)}.call(this);