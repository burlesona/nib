var root;root="undefined"!=typeof exports&&null!==exports?exports:this,root.Nib={Plugins:{}};var __slice=[].slice;Nib.Events=function(){function e(){this.handlers={}}return e.prototype.on=function(e,t){return null==this.handlers[e]&&(this.handlers[e]=[]),this.handlers[e].push(t),this},e.prototype.off=function(e,t){return null!=this.handlers[e]&&(this.handlers[e]=this.handlers[e].filter(function(e){return e===!t})),this},e.prototype.trigger=function(){var e,t,n,o,i,s;if(n=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],this.handlers[n]){for(s=this.handlers[n],o=0,i=s.length;i>o;o++)t=s[o],t.apply(null,__slice.call(e).concat([this]));return this}},e.prototype.clear=function(){return this.handlers={}},e}(),Nib.SelectionHandler=function(){function e(){this.selection=rangy.getSelection(),this.baseNode=this.selection.nativeSelection.baseNode,this.baseOffset=this.selection.nativeSelection.baseOffset,this.extentNode=this.selection.nativeSelection.extentNode,this.extentOffset=this.selection.nativeSelection.extentOffset,this.backwards=this.selection.isBackwards()}return e.prototype.restoreSelection=function(){var e,t;return t=rangy.createRange(),t.setStart(this.baseNode,this.baseOffset),this.selection.removeAllRanges(),this.backwards?(t.setEnd(this.baseNode,this.baseOffset),e=rangy.createRange(),e.setStart(this.extentNode,this.extentOffset),e.setEnd(this.extentNode,this.extentOffset),this.selection.addRange(t),this.selection.addRange(e,!0),e.detach()):(t.setEnd(this.extentNode,this.extentOffset),this.selection.setSingleRange(t)),t.detach()},e}(),Nib.Utils={capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},parentNodes:function(e,t){var n,o,i,s,r;if(t instanceof Array){for(r=[],i=0,s=t.length;s>i;i++)n=t[i],r.push(this.parentNodes(e,n));return r}for(o=[];t&&t!==e;)o.push(t),t=t.parentNode;return o},flatten:function(e){return 0===e.length?[]:e.reduce(function(e,t){return e.concat(t)})},uniqueNodes:function(e){var t,n,o,i,s,r;for(n=[],o=0,s=e.length;s>o;o++)t=e[o],t._visited||n.push(t),t._visited=!0;for(i=0,r=n.length;r>i;i++)t=n[i],t._visited=!1;return n},domNodes:function(e){return e.filter(function(e){return 1===e.nodeType})}};var _,__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__slice=[].slice;_=Nib.Utils,Nib.Editor=function(e){function t(e){null==e&&(e={}),this.opts=e,this.plugins=e.plugins||[],this.node=e.node,this.originalClass=this.node.className,this.originalContent=this.node.innerHTML,t.__super__.constructor.call(this,e)}return __extends(t,e),t.prototype.activate=function(){var e,t,n,o,i;for(this.node.setAttribute("contenteditable",!0),i=this.plugins,n=0,o=i.length;o>n;n++)t=i[n],e=_.capitalize(t),this[t]=new Nib.Plugins[e](this);return this.initDOMEvents(),this.trigger("editor:on")},t.prototype.deactivate=function(){var e,t,n,o;for(this.node.setAttribute("contenteditable",!1),o=this.plugins,t=0,n=o.length;n>t;t++)e=o[t],this[e].deactivate();return this.deactivateDOMEvents(),this.trigger("editor:off"),this.clear()},t.prototype.hasChanged=function(){return this.node.innerHTML!==this.originalContent},t.prototype.revert=function(){return this.node.innerHTML=this.originalContent},t.prototype.exec=function(){var e,t;return t=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],e.length>0?document.execCommand.apply(document,[t,!1].concat(__slice.call(e))):document.execCommand(t,!1,this.getSelection()),this.checkSelection()},t.prototype.initDOMEvents=function(){return this.node.addEventListener("keydown",this.onKeydown.bind(this)),this.node.addEventListener("keyup",this.onKeyup.bind(this)),this.node.addEventListener("mousedown",this.onMousedown.bind(this)),this.node.addEventListener("mouseup",this.onMouseup.bind(this))},t.prototype.deactivateDOMEvents=function(){return this.node.removeEventListener("keydown",this.onKeydown),this.node.removeEventListener("keyup",this.onKeyup),this.node.removeEventListener("mousedown",this.onMousedown),this.node.removeEventListener("mouseup",this.onMouseup)},t.prototype.onKeydown=function(e){return this.checkSelection(),this.trigger("keydown",e)},t.prototype.onKeyup=function(){return this.checkSelection()},t.prototype.onMousedown=function(){return this.checkSelection()},t.prototype.onMouseup=function(){return this.checkSelection()},t.prototype.getSelection=function(){return rangy.getSelection()},t.prototype.getSelectedNodes=function(){var e,t,n;return n=this.getSelection(),e=[],n.rangeCount&&(t=n.getRangeAt(0),t.collapsed?(t.startContainer||t.endContainer)&&(e=[t.startContainer||t.endContainer]):e=t.getNodes(),e=_.uniqueNodes(_.flatten(_.parentNodes(this.node,e))),t.detach()),n.detach(),e},t.prototype.checkSelection=function(){var e,t,n,o,i,s,r;for(o=this.getSelection(),o.rangeCount&&(n=o.getRangeAt(0)),t={selection:o,range:n,nodes:this.getSelectedNodes(),states:[]},r=this.plugins,i=0,s=r.length;s>i;i++)e=r[i],this[e].checkSelection(t)&&t.states.push(e);return this.trigger("report",t),this.detach(n)},t.prototype.detach=function(){var e,t,n,o,i;for(e=1<=arguments.length?__slice.call(arguments,0):[],i=[],n=0,o=e.length;o>n;n++)t=e[n],t&&i.push(t.detach());return i},t.prototype.saveSelection=function(){return new Nib.SelectionHandler},t.prototype.restoreSelection=function(e){return e.restoreSelection(),this.checkSelection()},t.prototype.wrap=function(e){var t,n,o,i;return i=this.getSelection(),o=i.getRangeAt(0),n=document.createElement(e),o.canSurroundContents()&&o.surroundContents(n),t=rangy.createRange(),t.selectNodeContents(n),i.setSingleRange(t),this.checkSelection(),this.detach(o),n},t.prototype.lookForTags=function(e,t){var n,o,i,s;for(o=[],i=0,s=t.length;s>i;i++)n=t[i],1===n.nodeType&&n.tagName.toLowerCase()===e&&o.push(n);return o},t.prototype.lookForTag=function(e,t){var n,o,i;for(o=0,i=t.length;i>o;o++)if(n=t[o],1===n.nodeType&&n.tagName.toLowerCase()===e)return n},t.prototype.wrapped=function(e){var t;return t=this.getSelectedNodes(),this.lookForTag(e,t)},t.prototype.unwrap=function(e){var t,n,o,i,s,r,a;for(o=this.getSelectedNodes(),s=this.lookForTags(e,o),i=this.saveSelection(),r=0,a=s.length;a>r;r++){for(n=s[r];t=n.firstChild;)n.parentNode.insertBefore(t,n);n.remove()}return this.restoreSelection(i),this.checkSelection()},t}(Nib.Events);