(function(){var t;t="undefined"!=typeof exports&&null!==exports?exports:this,t.Nib={Plugins:{}}}).call(this),function(){var t=[].slice;Nib.Events=function(){function e(){this.handlers={}}return e.prototype.on=function(t,e){return null==this.handlers[t]&&(this.handlers[t]=[]),this.handlers[t].push(e),this},e.prototype.off=function(t,e){return null!=this.handlers[t]&&(this.handlers[t]=this.handlers[t].filter(function(t){return t===!e})),this},e.prototype.trigger=function(){var e,n,r,o,i,s;if(r=arguments[0],e=2<=arguments.length?t.call(arguments,1):[],this.handlers[r]){for(s=this.handlers[r],o=0,i=s.length;i>o;o++)n=s[o],n.apply(null,t.call(e).concat([this]));return this}},e.prototype.clear=function(){return this.handlers={}},e}()}.call(this),function(){var t=[].slice;Nib.Utils={capitalize:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},parentNodes:function(t,e){var n,r,o,i,s;if(e instanceof Array){for(s=[],o=0,i=e.length;i>o;o++)n=e[o],s.push(this.parentNodes(t,n));return s}for(r=[];e&&e!==t;)r.push(e),e=e.parentNode;return r},flatten:function(t){return 0===t.length?[]:t.reduce(function(t,e){return t.concat(e)})},indexOf:function(t,e){var n;for(n=0;n<t.length;){if(t[n]===e)return n;n+=1}return-1},uniqueNodes:function(t){var e,n,r,o,i,s;for(n=[],r=0,i=t.length;i>r;r++)e=t[r],e._visited||n.push(e),e._visited=!0;for(o=0,s=n.length;s>o;o++)e=n[o],e._visited=!1;return n},domNodes:function(t){return t.filter(function(t){return 1===t.nodeType})},rangyDetach:function(){var e,n,r,o,i,s;for(e=1<=arguments.length?t.call(arguments,0):[],s=[],o=0,i=e.length;i>o;o++)if(r=e[o])try{s.push(r.detach())}catch(a){n=a,s.push(null)}return s}}}.call(this),function(){var t;t=Nib.Utils,Nib.SelectionHandler=function(){function t(){var t;t=rangy.getSelection(),t.rangeCount&&(this.range=t.getRangeAt(0),this.backwards=t.isBackwards())}return t.prototype.restoreSelection=function(){var t,e;return this.range?(t=rangy.createRange(),t.setStart(this.range.startContainer,this.range.startOffset),t.setEnd(this.range.endContainer,this.range.endOffset),e=rangy.getSelection(),e.removeAllRanges(),e.addRange(t,this.backwards)):void 0},t.prototype.collapseToEnd=function(){return rangy.getSelection().collapseToEnd()},t.prototype.collapseToStart=function(){return rangy.getSelection().collapseToStart()},t}()}.call(this),function(){var t,e={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},r=[].slice;t=Nib.Utils,Nib.Editor=function(e){function o(t){null==t&&(t={}),this.opts=t,this.plugins=t.plugins||[],this.node=t.node,this.originalClass=this.node.className,this.originalContent=this.node.innerHTML,o.__super__.constructor.call(this,t)}return n(o,e),o.prototype.activate=function(){var e,n,r,o,i;for(this.node.setAttribute("contenteditable",!0),i=this.plugins,r=0,o=i.length;o>r;r++)n=i[r],e=t.capitalize(n),this[n]=new Nib.Plugins[e](this);return this.initDOMEvents(),this.trigger("editor:on")},o.prototype.deactivate=function(){var t,e,n,r;for(this.node.setAttribute("contenteditable",!1),r=this.plugins,e=0,n=r.length;n>e;e++)t=r[e],this[t].deactivate();return this.deactivateDOMEvents(),this.trigger("editor:off"),this.clear()},o.prototype.hasChanged=function(){return this.node.innerHTML!==this.originalContent},o.prototype.revert=function(){return this.node.innerHTML=this.originalContent},o.prototype.exec=function(){var t,e;return e=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],t.length>0?document.execCommand.apply(document,[e,!1].concat(r.call(t))):document.execCommand(e,!1,this.getSelection()),this.checkSelection()},o.prototype.initDOMEvents=function(){return this.node.addEventListener("keydown",this.onKeydown.bind(this)),this.node.addEventListener("keyup",this.onKeyup.bind(this)),this.node.addEventListener("mouseup",this.onMouseup.bind(this))},o.prototype.deactivateDOMEvents=function(){return this.node.removeEventListener("keydown",this.onKeydown),this.node.removeEventListener("keyup",this.onKeyup),this.node.removeEventListener("mouseup",this.onMouseup)},o.prototype.onKeydown=function(t){return this.trigger("keydown",t)},o.prototype.onKeyup=function(){return this.checkSelection()},o.prototype.onMouseup=function(){return this.checkSelection()},o.prototype.getContent=function(){return this.node.innerHTML},o.prototype.contentBeforeSelection=function(){var t,e;return e=this.getSelection(),t=rangy.createRange(),t.setStart(this.node,0),t.setEnd(e.anchorNode,e.anchorOffset),t.toHtml()},o.prototype.contentInSelection=function(){var t,e;return e=this.getSelection(),t=e.getRangeAt(0),t.toHtml()},o.prototype.contentAfterSelection=function(){var t,e,n;return n=this.getSelection(),e=n.getRangeAt(0),t=rangy.createRange(),t.setStart(e.endContainer,e.endOffset),t.setEnd(this.node,this.node.childNodes.length),t.toHtml()},o.prototype.getSelection=function(){return rangy.getSelection()},o.prototype.getSelectedNodes=function(e){var n,r;return null==e&&(e=null),e=e||this.getSelection(),n=[],e.rangeCount&&(r=e.getRangeAt(0),r.collapsed?(r.startContainer||r.endContainer)&&(n=[r.startContainer||r.endContainer]):n=r.getNodes(),n=t.uniqueNodes(t.flatten(t.parentNodes(this.node,n))),this.detach(r)),this.detach(e),n},o.prototype.checkSelection=function(t){var e,n,r,o,i,s;for(null==t&&(t=null),t=t||this.getSelection(),t.rangeCount&&(r=t.getRangeAt(0)),n={selection:t,range:r,nodes:this.getSelectedNodes(t),states:[]},s=this.plugins,o=0,i=s.length;i>o;o++)e=s[o],this[e].checkSelection(n)&&n.states.push(e);return this.trigger("report",n),this.detach(r)},o.prototype.detach=function(){var e;return e=1<=arguments.length?r.call(arguments,0):[],t.rangyDetach.apply(t,e)},o.prototype.saveSelection=function(){return new Nib.SelectionHandler},o.prototype.restoreSelection=function(t){return t.restoreSelection(),this.checkSelection()},o.prototype.selectNode=function(t,e){var n;return null==e&&(e=null),e=e||this.getSelection(),e.rangeCount?(n=e.getRangeAt(0),n.selectNode(t)):(n=rangy.createRange(),n.selectNodeContents(t),e.setSingleRange(n)),this.checkSelection(e)},o.prototype.wrap=function(t,e){var n,r,o;return null==e&&(e=null),e=e||this.getSelection(),e.rangeCount&&(o=e.getRangeAt(0)),r=document.createElement(t),o&&o.canSurroundContents()&&o.surroundContents(r),n=rangy.createRange(),n.selectNodeContents(r),e.setSingleRange(n),this.checkSelection(e),this.detach(o),r},o.prototype.findTags=function(t,e){var n,r,o,i;for(t=t.toUpperCase(),i=[],r=0,o=e.length;o>r;r++)n=e[r],1===n.nodeType&&n.tagName===t&&i.push(n);return i},o.prototype.findTag=function(t,e){var n,r,o;for(t=t.toUpperCase(),r=0,o=e.length;o>r;r++)if(n=e[r],1===n.nodeType&&n.tagName===t)return n},o.prototype.wrapped=function(t){return this.findTag(t,this.getSelectedNodes())},o.prototype.findBoundary=function(t,e){for(t=t.toUpperCase();e!==this.node;){if(1===e.nodeType&&(e.tagName=t))return!0;e=e.parentNode}return!1},o.prototype.splitNodeBoundary=function(e,n,r){var o,i,s,a,l;return l=e.parentNode,o=l.cloneNode(!0),i=o.firstChild,s=l.parentNode,r?(i.deleteData(n,i.textContent.length),e.deleteData(0,n),s.insertBefore(o,l)):(i.deleteData(0,n),e.deleteData(n,i.textContent.length),a=l.nextSibling,a?s.insertBefore(o,a):s.appendChild(o)),[s,t.indexOf(s.childNodes,l)]},o.prototype.splitElementBoundry=function(e,n,r){var o,i,s,a,l,c,u;if(o=e.cloneNode(!1),s=e.parentNode,i=e.childNodes,r){if(n)for(c=1;n>=1?n>=c:c>=n;n>=1?c++:c--)o.appendChild(i[0]);s.insertBefore(o,e)}else{if(l=i.length-n-1)for(u=1;l>=1?l>=u:u>=l;l>=1?u++:u--)o.appendChild(i[n+1]);a=e.nextSibling,a?s.insertBefore(o,a):s.appendChild(o)}return[s,t.indexOf(s.childNodes,e)]},o.prototype.splitBoundaryRecursive=function(t,e,n,r){var o,i,s;for(t=t.toUpperCase();;){if(e===this.node)return;if(o=1===e.nodeType&&e.tagName===t,1===e.nodeType?(i=this.splitElementBoundry(e,n,r),e=i[0],n=i[1]):(s=this.splitNodeBoundary(e,n,r),e=s[0],n=s[1]),o)return}},o.prototype.splitBoundaries=function(t){var e,n;return n=rangy.getSelection(),n.rangeCount&&(e=n.getRangeAt(0),e.collapsed||(e.startContainer&&this.findBoundary(t,e.startContainer)&&e.startOffset>0&&(this.splitBoundaryRecursive(t,e.startContainer,e.startOffset,!0),e.refresh()),e.endContainer&&this.findBoundary(t,e.endContainer)&&e.endOffset<e.endContainer.length&&(this.splitBoundaryRecursive(t,e.endContainer,e.endOffset,!1),e.refresh())),this.detach(e)),this.detach(n)},o.prototype.unwrap=function(t){var e,n,r,o,i,s;for(this.splitBoundaries(t),r=this.saveSelection(),s=this.findTags(t,this.getSelectedNodes()),o=0,i=s.length;i>o;o++){for(n=s[o];e=n.firstChild;)n.parentNode.insertBefore(e,n);n.remove()}return this.restoreSelection(r),this.checkSelection()},o}(Nib.Events)}.call(this);